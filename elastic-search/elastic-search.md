# ES 공부

## 인덱스와 샤드

- 도큐먼트 : 단일 데이터 단위
- 인덱스 : 도큐먼트의 집합
- 샤드 : 인덱스가 분리되는 단위. 샤드는 각 노드에 분산되어 저장된다.

### 프라이머리 샤드와 Replica

* 인덱스 생성시 디폴트로 7.0이상은 1개, 6.x 이하는 5개의 샤드로 구성된다. 
* 한 인덱스가 5개의 샤드, 1개의 복제본, 4개의 노드로 구성됭더 있으면, 5개의 프라이머리 샤드와 5개의 레플리카 샤드, 총 10개의 샤드가 4개의 노드에 분산되어 생성된다.
* **같은 샤드와 복제본은 동일한 데이터를 담고 있으며, 반드시 서로 다른 노드에 저장된다.** 이로 인해 노드 하나가 다운되어도, 다른 노드에 있는 샤드로 데이터 유실을 방지할 수 있다. **가용성과 무결성을 보장해 준다.**



## 마스터 노드와 데이터 노드

### 마스터 노드

* 클러스터에서 하나의 노드는 인덱스의 메타 데이터, 샤드의 위치와 같은 클러스터의 상태 정보를 관리하는 역할을 수행하는데, 이를 마스터 노드 라고 한다.
* 마스터 노드가 없으면 클러스터의 작동은 정지한다.
* elasticsearch.yml 에서 `node.master: true` 로 되어있으면, 마스터 노드가 될 수 있는 후보가 된다. 기본이 true 이며, 모든 노드가 마스터 노드의 정보를 공유하는 것은 부담이 될 수 있어서 적당히 역할을 나누면 된다.

### 데이터 노드

* 색인된 데이터를 저장하는 노드.
* elasticsearch.yml 에서 `node.data: true` 로 설정한다. 

### Split Brain

![image-20210104223647239](images/image-20210104223647239.png)

* 마스터 노드는 최소 3개 이상의 홀수개로 설정해야 한다. 그렇지 않으면 Split Brain 문제가 생길 수 있다.
* 위 그림과 같이 구성 시 마스터노드 후보가 서로 단절 되면 각자 다른 클러스터로 동작하는 경우가 발생한다. 이때 다시 복구되면 데이터 정합성에 문제가 생기게 될 수 있다. 이를 Split Brain 문제라고 한다.
* 방지하기 위해서는 마스터 후보 노드를 3개로 두고, 마스터 후보 노드가 최소 2개 이상 존재하고 있을때에만 클러스터가 동작하게 해야 한다. `discovery.zen.minimum_master_nodes: 2` 와 같이 설정 가능하다.
* 해당 값은 `(전체 마스터 후보 노드 / 2) + 1` 개로 설정되어야 한다.
* 7.0 부터는 해당 설정이 사라지고, 마스터 후보 노드가 추가되면 스스로 해당 값을 설정한다.



